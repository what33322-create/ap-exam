<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Exam Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== SAME STYLES AS ORIGINAL FILE ===== */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --error: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0,0,0,.1);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,.25);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:var(--light); color:var(--dark); line-height:1.6;
        }
        .container { max-width:1200px; margin:0 auto; padding:0 1rem; }
        .header {
            position:sticky; top:0; height:72px; background:rgba(248,250,252,.95);
            backdrop-filter:blur(10px); border-bottom:1px solid var(--border);
            box-shadow:0 2px 4px rgba(0,0,0,.06); z-index:100;
        }
        .header-content { display:flex; justify-content:space-between; align-items:center; height:100%; padding:0 1rem; }
        .logo { display:flex; align-items:center; gap:.5rem; cursor:pointer; font-size:1.5rem; font-weight:bold; color:var(--primary); }
        .nav-buttons { display:flex; gap:1rem; align-items:center; }
        .btn {
            padding:.5rem 1rem; border:none; border-radius:.5rem; cursor:pointer;
            font-size:.875rem; font-weight:500; transition:all .2s ease;
            display:inline-flex; align-items:center; gap:.5rem; outline:none;
        }
        .btn:focus { outline:2px solid var(--primary); outline-offset:2px; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-primary:hover { background:var(--primary-dark); }
        .btn-outline { background:transparent; color:var(--primary); border:1px solid var(--primary); }
        .btn-outline:hover { background:var(--primary); color:white; }
        .btn-danger { background:var(--error); color:white; }
        .btn-danger:hover { background:#dc2626; }
        .notification-bar {
            position:fixed; top:72px; left:0; right:0; z-index:99;
            transform:translateY(-100%); transition:transform .3s ease;
        }
        .notification-bar.show { transform:translateY(0); }
        .notification-content {
            background:white; margin:0 auto; max-width:1200px; padding:1rem;
            border-radius:0 0 .5rem .5rem; box-shadow:var(--shadow);
            display:flex; align-items:center; gap:.5rem;
        }
        .notification-success { border-left:4px solid var(--success); }
        .notification-error { border-left:4px solid var(--error); }
        .notification-info { border-left:4px solid var(--accent); }
        .page { display:none; min-height:calc(100vh - 72px); padding:2rem 0; }
        .page.active { display:block; }
        .hero {
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color:white; text-align:center; padding:4rem 1rem; margin-bottom:2rem;
            border-radius:1rem;
        }
        .hero h1 { font-size:3.5rem; font-weight:bold; margin-bottom:1rem; text-shadow:2px 2px 4px rgba(0,0,0,.3); }
        .hero p { font-size:1.25rem; opacity:.9; }
        .course-grid {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
            gap:2rem; margin-bottom:2rem;
        }
        .course-card {
            background:white; border-radius:.5rem; padding:1.5rem; box-shadow:var(--shadow);
            transition:all .3s ease; cursor:pointer; position:relative; border-top:4px solid var(--primary);
        }
        .course-card:hover { transform:translateY(-8px); box-shadow:var(--shadow-lg); }
        .course-emoji { font-size:3rem; margin-bottom:1rem; }
        .course-title { font-size:1.5rem; font-weight:bold; margin-bottom:.5rem; color:var(--dark); }
        .course-description { color:var(--gray); margin-bottom:1rem; }
        .delete-course {
            position:absolute; top:1rem; right:1rem; background:var(--error); color:white;
            border:none; border-radius:50%; width:2rem; height:2rem; cursor:pointer; display:none;
            align-items:center; justify-content:center;
        }
        .developer-mode .delete-course { display:flex; }
        .form-group { margin-bottom:1rem; }
        .form-label { display:block; margin-bottom:.5rem; font-weight:500; color:var(--dark); }
        .form-input,.form-textarea,.form-select {
            width:100%; padding:.75rem; border:1px solid var(--border); border-radius:.5rem;
            font-size:1rem; transition:border-color .2s ease;
        }
        .form-input:focus,.form-textarea:focus,.form-select:focus {
            outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(99,102,241,.1);
        }
        .form-textarea { resize:vertical; min-height:120px; }
        .dev-controls {
            background:white; border-radius:.5rem; padding:2rem; margin-bottom:2rem;
            box-shadow:var(--shadow); display:none;
        }
        .developer-mode .dev-controls { display:block; }
        .course-detail {
            background:white; border-radius:.5rem; padding:2rem; box-shadow:var(--shadow-lg);
            margin-bottom:2rem;
        }
        .section { margin-bottom:2rem; }
        .section-title { font-size:1.25rem; font-weight:bold; margin-bottom:1rem; color:var(--dark); }
        .dropdown-section {
            background:#f8fafc; border:1px solid var(--border); border-radius:.5rem;
            margin-bottom:1rem; overflow:hidden;
        }
        .dropdown-header {
            background:white; padding:1rem; cursor:pointer; display:flex; justify-content:space-between;
            align-items:center; border-bottom:1px solid var(--border); transition:background-color .2s ease;
        }
        .dropdown-header:hover { background:#f8fafc; }
        .dropdown-content { padding:1rem; display:none; }
        .dropdown-content.active { display:block; }
        .dropdown-icon { transition:transform .2s ease; }
        .dropdown-icon.rotated { transform:rotate(180deg); }
        .links-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1rem; margin-bottom:1rem; }
        .link-card {
            background:white; border:1px solid var(--border); border-radius:.5rem; padding:1rem;
            border-left:4px solid var(--accent); display:flex; justify-content:space-between; align-items:center;
        }
        .link-title { font-weight:500; color:var(--dark); }
        .delete-link {
            background:var(--error); color:white; border:none; border-radius:.25rem;
            padding:.25rem .5rem; cursor:pointer; font-size:.75rem;
        }
        .chat-container {
            background:white; border:1px solid var(--border); border-radius:.5rem; height:400px;
            display:flex; flex-direction:column;
        }
        .chat-messages { flex:1; overflow-y:auto; padding:1rem; }
        .chat-input-container {
            border-top:1px solid var(--border); padding:1rem; display:flex; gap:.5rem;
        }
        .chat-input { flex:1; padding:.5rem; border:1px solid var(--border); border-radius:.25rem; }
        .message { margin-bottom:1rem; padding:.75rem; border-radius:.5rem; max-width:80%; }
        .message.user { background:var(--primary); color:white; margin-left:auto; text-align:right; }
        .message.bot { background:white; border:1px solid var(--border); margin-right:auto; }
        .chat-locked {
            display:flex; align-items:center; justify-content:center; height:100%;
            color:var(--gray); text-align:center;
        }
        .note-card { background:white; border-radius:.5rem; padding:1.5rem; box-shadow:var(--shadow); margin-bottom:1rem; }
        .note-meta { color:var(--gray); font-size:.875rem; margin-bottom:.5rem; }
        .rating-container { display:flex; align-items:center; gap:.5rem; margin-bottom:1rem; }
        .rating-stars { display:flex; gap:.25rem; }
        .rating-star {
            cursor:pointer; font-size:1.25rem; color:#d1d5db; transition:color .2s ease;
        }
        .rating-star.active { color:#fbbf24; }
        .rating-star:hover { color:#f59e0b; }
        .rating-display { display:flex; align-items:center; gap:.25rem; font-size:.875rem; color:var(--gray); }
        .filter-container { background:white; border-radius:.5rem; padding:1.5rem; box-shadow:var(--shadow); margin-bottom:2rem; }
        .filter-row { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
        .filter-group { display:flex; flex-direction:column; gap:.5rem; }
        .filter-label { font-size:.875rem; font-weight:500; color:var(--dark); }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-bottom:2rem; }
        .stat-card { background:white; border-radius:.5rem; padding:1.5rem; text-align:center; box-shadow:var(--shadow); }
        .stat-number { font-size:2rem; font-weight:bold; color:var(--primary); }
        .stat-label { color:var(--gray); font-size:.875rem; }
        .table-container { background:white; border-radius:.5rem; overflow:hidden; box-shadow:var(--shadow); }
        .table { width:100%; border-collapse:collapse; }
        .table th,.table td { padding:1rem; text-align:left; border-bottom:1px solid var(--border); }
        .table th { background:#f8fafc; font-weight:600; color:var(--dark); }
        .table-row { border-left:3px solid transparent; }
        .table-row:hover { background:#f8fafc; border-left-color:var(--success); }
        .auth-container { max-width:400px; margin:0 auto; background:white; border-radius:.5rem; padding:2rem; box-shadow:var(--shadow-lg); }
        .auth-toggle { text-align:center; margin-top:1rem; color:var(--primary); cursor:pointer; text-decoration:underline; }
        .hidden { display:none !important; }
        .text-center { text-align:center; }
        .mb-2 { margin-bottom:.5rem; }
        .mb-4 { margin-bottom:1rem; }
        .mt-4 { margin-top:1rem; }
        .w-full { width:100%; }
        .markdown-content h1,.markdown-content h2,.markdown-content h3 { margin-bottom:.5rem; color:var(--dark); }
        .markdown-content p { margin-bottom:1rem; }
        .markdown-content strong { font-weight:bold; }
        .markdown-content details { margin-bottom:1rem; border:1px solid var(--border); border-radius:.25rem; }
        .markdown-content summary { padding:.5rem; background:#f8fafc; cursor:pointer; font-weight:500; }
        .markdown-content details[open] > *:not(summary) { padding:.5rem; }
        @media(max-width:768px){
            .header-content { flex-direction:column; gap:1rem; height:auto; padding:1rem; }
            .header { height:auto; }
            .hero h1 { font-size:2.5rem; }
            .course-grid { grid-template-columns:1fr; }
            .nav-buttons { flex-wrap:wrap; justify-content:center; }
            .container { padding:0 .5rem; }
            .filter-row { flex-direction:column; align-items:stretch; }
        }
    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <div class="logo" onclick="showPage('home')">
            <i class="fas fa-graduation-cap"></i>
            <span>AP Exam Center</span>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-outline" onclick="showPage('community')">
                <i class="fas fa-users"></i> Community
            </button>
            <button class="btn btn-outline" onclick="showPage('dev')">
                <i class="fas fa-code"></i> Dev
            </button>
            <button id="auth-button" class="btn btn-primary" onclick="showPage('auth')">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
        </div>
    </div>
</header>

<div id="notification-bar" class="notification-bar">
    <div id="notification-content" class="notification-content">
        <i id="notification-icon" class="fas fa-info-circle"></i>
        <span id="notification-text"></span>
    </div>
</div>

<!-- Home Page -->
<div id="home-page" class="page active">
    <div class="container">
        <div class="hero">
            <h1>Master Your AP Exams</h1>
            <p>Comprehensive study resources, community notes, and AI-powered assistance</p>
        </div>
        <div class="dev-controls">
            <h3 class="mb-4">Developer Controls</h3>
            <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                <button class="btn btn-primary" onclick="toggleAddCourseForm()">
                    <i class="fas fa-plus"></i> Add New Course
                </button>
                <button class="btn btn-outline" onclick="showPage('dev')">
                    <i class="fas fa-cog"></i> Dev Dashboard
                </button>
                <button class="btn btn-danger" onclick="exitDeveloperMode()">
                    <i class="fas fa-sign-out-alt"></i> Exit Dev Mode
                </button>
            </div>
            <div id="add-course-form" class="hidden">
                <div class="form-group">
                    <label class="form-label">Course Title</label>
                    <input type="text" id="new-course-title" class="form-input" placeholder="e.g., AP Calculus AB">
                </div>
                <div class="form-group">
                    <label class="form-label">Emoji Icon</label>
                    <input type="text" id="new-course-emoji" class="form-input" placeholder="ðŸ“Š" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="new-course-description" class="form-input" placeholder="Brief course description">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (Markdown)</label>
                    <textarea id="new-course-notes" class="form-textarea" placeholder="# Course Overview"></textarea>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="saveNewCourse()">
                        <i class="fas fa-save"></i> Save Course
                    </button>
                    <button class="btn btn-outline" onclick="toggleAddCourseForm()">Cancel</button>
                </div>
            </div>
        </div>
        <div id="course-grid" class="course-grid"></div>
    </div>
</div>

<!-- Course Detail Page -->
<div id="course-detail-page" class="page">
    <div class="container">
        <div class="course-detail">
            <button class="btn btn-outline mb-4" onclick="showPage('home')">
                <i class="fas fa-arrow-left"></i> Back to Courses
            </button>
            <h1 id="course-detail-title" class="mb-4"></h1>

            <!-- Edit Notes Button -->
            <button class="btn btn-outline mb-4" onclick="toggleEditNotes()">
                <i class="fas fa-edit"></i> Edit Notes
            </button>

            <!-- Edit Notes Form -->
            <div id="edit-notes-form" class="hidden mb-4">
                <div class="form-group">
                    <label class="form-label">Edit Notes (Markdown)</label>
                    <textarea id="edit-notes-textarea" class="form-textarea" rows="10"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveEditedNotes()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button class="btn btn-outline" onclick="toggleEditNotes()">Cancel</button>
            </div>

            <div class="section">
                <h2 class="section-title"><i class="fas fa-book"></i> Course Notes</h2>
                <div id="notes-dropdowns"></div>
            </div>

            <div class="section">
                <h2 class="section-title"><i class="fas fa-link"></i> Useful Links</h2>
                <div id="links-grid" class="links-grid"></div>
                <button class="btn btn-primary" onclick="toggleAddLinkForm()">
                    <i class="fas fa-plus"></i> Add Link
                </button>
                <div id="add-link-form" class="hidden mt-4">
                    <div class="form-group">
                        <label class="form-label">Link Title</label>
                        <input type="text" id="new-link-title" class="form-input" placeholder="e.g., Official AP Website">
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL</label>
                        <input type="url" id="new-link-url" class="form-input" placeholder="https://apstudents.collegeboard.org/">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="saveNewLink()">
                            <i class="fas fa-save"></i> Save Link
                        </button>
                        <button class="btn btn-outline" onclick="toggleAddLinkForm()">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title"><i class="fas fa-robot"></i> AI Study Assistant</h2>
                <div id="chat-container" class="chat-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- Community Page -->
<div id="community-page" class="page">
    <div class="container">
        <h1 class="mb-4"><i class="fas fa-users"></i> Community Notes</h1>
        <div class="upload-card">
            <h2 class="mb-4">Share Your Notes</h2>
            <div class="form-group">
                <label class="form-label">Course</label>
                <select id="upload-course-select" class="form-select">
                    <option value="">Select a course</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Note Title</label>
                <input type="text" id="upload-note-title" class="form-input" placeholder="e.g., Calculus Derivatives Summary">
            </div>
            <div class="form-group">
                <label class="form-label">Note Content (Markdown with Dropdowns)</label>
                <textarea id="upload-note-content" class="form-textarea" placeholder="# Unit 1: Limits"></textarea>
            </div>
            <button class="btn btn-primary" onclick="uploadNote()">
                <i class="fas fa-upload"></i> Share Note
            </button>
            <div id="upload-guest-message" class="hidden mt-2" style="color:var(--gray);">
                <i class="fas fa-lock"></i> Please sign in to share notes
            </div>
        </div>
        <div class="filter-container">
            <h3 class="mb-4">Filter Notes</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">Course</label>
                    <select id="filter-course" class="form-select" onchange="applyFilters()">
                        <option value="">All Courses</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Minimum Rating</label>
                    <select id="filter-rating" class="form-select" onchange="applyFilters()">
                        <option value="">Any Rating</option>
                        <option value="5">5 Stars</option>
                        <option value="4">4+ Stars</option>
                        <option value="3">3+ Stars</option>
                        <option value="2">2+ Stars</option>
                        <option value="1">1+ Stars</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sort By</label>
                    <select id="filter-sort" class="form-select" onchange="applyFilters()">
                        <option value="rating">Rating (High to Low)</option>
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="community-notes-list"></div>
    </div>
</div>

<!-- View Note Page -->
<div id="note-view-page" class="page">
    <div class="container">
        <button class="btn btn-outline mb-4" onclick="showPage('community')">
            <i class="fas fa-arrow-left"></i> Back to Community
        </button>
        <div class="note-card">
            <h1 id="view-note-title"></h1>
            <div id="view-note-meta" class="note-meta"></div>
            <div id="view-note-rating" class="rating-display mb-4">
                <div class="rating-stars" id="view-rating-stars"></div>
                <span id="view-rating-text"></span>
            </div>
            <div id="user-rating-section" class="rating-container mb-4 hidden">
                <label class="form-label">Rate these notes:</label>
                <div class="rating-stars" id="user-rating-stars">
                    <i class="fas fa-star rating-star" data-rating="1" onclick="setUserRating(1)"></i>
                    <i class="fas fa-star rating-star" data-rating="2" onclick="setUserRating(2)"></i>
                    <i class="fas fa-star rating-star" data-rating="3" onclick="setUserRating(3)"></i>
                    <i class="fas fa-star rating-star" data-rating="4" onclick="setUserRating(4)"></i>
                    <i class="fas fa-star rating-star" data-rating="5" onclick="setUserRating(5)"></i>
                </div>
                <button class="btn btn-primary" onclick="submitRating()">
                    <i class="fas fa-check"></i> Submit Rating
                </button>
            </div>
            <div id="view-note-content" class="markdown-content"></div>
        </div>
    </div>
</div>

<!-- Developer Dashboard -->
<div id="dev-page" class="page">
    <div class="container">
        <h1 class="mb-4"><i class="fas fa-code"></i> Developer Dashboard</h1>
        <div id="dev-password-section" class="auth-container mb-4">
            <h2 class="mb-4">Developer Access</h2>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="dev-password" class="form-input" placeholder="Enter developer password">
            </div>
            <button class="btn btn-primary" onclick="enableDeveloperMode()">
                <i class="fas fa-unlock"></i> Enable Developer Mode
            </button>
        </div>
        <div id="dev-content" class="hidden">
            <div class="mb-4">
                <button class="btn btn-danger" onclick="exitDeveloperMode()">
                    <i class="fas fa-sign-out-alt"></i> Exit Developer Mode
                </button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div id="total-users" class="stat-number">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div id="guest-users" class="stat-number">0</div>
                    <div class="stat-label">Guest Users</div>
                </div>
                <div class="stat-card">
                    <div id="total-notes" class="stat-number">0</div>
                    <div class="stat-label">Community Notes</div>
                </div>
                <div class="stat-card">
                    <div id="avg-session" class="stat-number">0m</div>
                    <div class="stat-label">Avg Session Time</div>
                </div>
            </div>
            <div class="mb-4">
                <h2 class="mb-4">Registered Users</h2>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Registration Date</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div>
                <h2 class="mb-4">Recent Activity</h2>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>User</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auth Page -->
<div id="auth-page" class="page">
    <div class="container">
        <div class="auth-container">
            <h1 id="auth-title" class="mb-4">Sign In</h1>
            <form id="auth-form" onsubmit="handleAuth(event)">
                <div id="name-field" class="form-group hidden">
                    <label class="form-label">Name</label>
                    <input type="text" id="auth-name" class="form-input" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="auth-email" class="form-input" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="auth-password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i>
                    <span id="auth-submit-text">Sign In</span>
                </button>
            </form>
            <div class="auth-toggle" onclick="toggleAuthMode()">
                <span id="auth-toggle-text">Don't have an account? Sign Up</span>
            </div>
        </div>
    </div>
</div>

<script>
// ===== GLOBAL STATE =====
window.appData = {
    courses: [],
    users: [],
    communityNotes: [],
    analytics: { totalUsers: 0, guestUsers: 0, registeredUsers: 0, sessions: [] },
    userRatings: {}
};
window.currentUser = null;
window.currentCourse = null;
window.currentNote = null;
window.isSignUpMode = false;
window.developerModeEnabled = false;
window.userRating = 0;

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    initializeDefaultData();
    updateUI();
    showPage('home');
    trackEvent('page_view', { page: 'home' });
});

// ===== DATA =====
function loadData() {
    const saved = localStorage.getItem('apExamAppData');
    if (saved) Object.assign(window.appData, JSON.parse(saved));
    const user = localStorage.getItem('currentUser');
    if (user) window.currentUser = JSON.parse(user);
}
function saveData() {
    localStorage.setItem('apExamAppData', JSON.stringify(window.appData));
    localStorage.setItem('currentUser', JSON.stringify(window.currentUser));
}
function initializeDefaultData() {
    if (window.appData.courses.length === 0) {
        window.appData.courses = [
            {
                id: 1,
                title: 'AP Calculus AB',
                icon: 'ðŸ“Š',
                description: 'Master differential and integral calculus concepts',
                notes: '# AP Calculus AB\n\n## Key Concepts\n- Limits\n- Derivatives\n- Integrals',
                links: [
                    { title: 'Official AP Calculus AB', url: 'https://apstudents.collegeboard.org/courses/ap-calculus-ab' }
                ]
            }
        ];
    }
}

// ===== NAV =====
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId + '-page').classList.add('active');
    updatePageContent(pageId);
    trackEvent('page_view', { page: pageId });
}
function updatePageContent(pageId) {
    switch (pageId) {
        case 'home': renderCourseGrid(); updateDeveloperMode(); break;
        case 'course-detail': renderCourseDetail(); break;
        case 'community': renderCommunityPage(); break;
        case 'dev': renderDevDashboard(); break;
        case 'auth': updateAuthUI(); break;
        case 'note-view': renderNoteView(); break;
    }
}

// ===== COURSES =====
function renderCourseGrid() {
    const grid = document.getElementById('course-grid');
    grid.innerHTML = '';
    window.appData.courses.forEach(course => {
        const card = document.createElement('div');
        card.className = 'course-card';
        card.onclick = () => openCourse(course.id);
        card.innerHTML = `
            <button class="delete-course" onclick="event.stopPropagation(); deleteCourse(${course.id})">
                <i class="fas fa-trash"></i>
            </button>
            <div class="course-emoji">${course.icon}</div>
            <div class="course-title">${course.title}</div>
            <div class="course-description">${course.description}</div>
        `;
        grid.appendChild(card);
    });
}
function openCourse(id) {
    window.currentCourse = window.appData.courses.find(c => c.id === id);
    if (window.currentCourse) showPage('course-detail');
}
function deleteCourse(id) {
    if (confirm('Delete this course?')) {
        window.appData.courses = window.appData.courses.filter(c => c.id !== id);
        saveData();
        renderCourseGrid();
        showNotification('Course deleted', 'success');
    }
}

// ===== DEV MODE =====
function toggleAddCourseForm() {
    document.getElementById('add-course-form').classList.toggle('hidden');
}
function saveNewCourse() {
    const title = document.getElementById('new-course-title').value.trim();
    const emoji = document.getElementById('new-course-emoji').value.trim();
    const desc = document.getElementById('new-course-description').value.trim();
    const notes = document.getElementById('new-course-notes').value.trim();
    if (!title || !emoji || !desc) return showNotification('Fill all fields', 'error');
    const course = { id: Date.now(), title, icon: emoji, description: desc, notes: notes || '# New Course\n\nNo notes yet.', links: [] };
    window.appData.courses.push(course);
    saveData();
    renderCourseGrid();
    toggleAddCourseForm();
    showNotification('Course added', 'success');
}
function updateDeveloperMode() {
    document.body.classList.toggle('developer-mode', window.developerModeEnabled);
}
function exitDeveloperMode() {
    window.developerModeEnabled = false;
    updateDeveloperMode();
    showPage('home');
}

// ===== COURSE DETAIL =====
function renderCourseDetail() {
    if (!window.currentCourse) return;
    document.getElementById('course-detail-title').textContent = window.currentCourse.title;
    document.getElementById('notes-dropdowns').innerHTML = parseMarkdown(window.currentCourse.notes);
    renderLinks();
    initializeChat();
}
function toggleEditNotes() {
    const form = document.getElementById('edit-notes-form');
    const isHidden = form.classList.contains('hidden');
    if (isHidden) document.getElementById('edit-notes-textarea').value = window.currentCourse.notes;
    form.classList.toggle('hidden');
}
function saveEditedNotes() {
    const newNotes = document.getElementById('edit-notes-textarea').value.trim();
    if (!newNotes) return showNotification('Notes cannot be empty', 'error');
    window.currentCourse.notes = newNotes;
    const index = window.appData.courses.findIndex(c => c.id === window.currentCourse.id);
    if (index !== -1) window.appData.courses[index] = window.currentCourse;
    saveData();
    renderCourseDetail();
    toggleEditNotes();
    showNotification('Notes updated', 'success');
}

// ===== LINKS =====
function renderLinks() {
    const grid = document.getElementById('links-grid');
    grid.innerHTML = '';
    (window.currentCourse.links || []).forEach((link, i) => {
        const card = document.createElement('div');
        card.className = 'link-card';
        card.innerHTML = `
            <div>
                <div class="link-title">${link.title}</div>
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" style="color:var(--accent);font-size:.875rem;">
                    <i class="fas fa-external-link-alt"></i> ${link.url}
                </a>
            </div>
            <button class="delete-link" onclick="deleteLink(${i})">
                <i class="fas fa-trash"></i>
            </button>
        `;
        grid.appendChild(card);
    });
}
function toggleAddLinkForm() {
    document.getElementById('add-link-form').classList.toggle('hidden');
}
function saveNewLink() {
    const title = document.getElementById('new-link-title').value.trim();
    const url = document.getElementById('new-link-url').value.trim();
    if (!title || !url) return showNotification('Fill all fields', 'error');
    if (!isValidUrl(url)) return showNotification('Invalid URL', 'error');
    if (!window.currentCourse.links) window.currentCourse.links = [];
    window.currentCourse.links.push({ title, url });
    const index = window.appData.courses.findIndex(c => c.id === window.currentCourse.id);
    if (index !== -1) window.appData.courses[index] = window.currentCourse;
    saveData();
    renderLinks();
    toggleAddLinkForm();
    showNotification('Link added', 'success');
}
function deleteLink(i) {
    window.currentCourse.links.splice(i, 1);
    const index = window.appData.courses.findIndex(c => c.id === window.currentCourse.id);
    if (index !== -1) window.appData.courses[index] = window.currentCourse;
    saveData();
    renderLinks();
    showNotification('Link deleted', 'success');
}

// ===== CHAT =====
function initializeChat() {
    const container = document.getElementById('chat-container');
    if (!window.currentUser) {
        container.innerHTML = `
            <div class="chat-locked">
                <i class="fas fa-lock" style="font-size:2rem;margin-bottom:1rem;"></i>
                <p>Please sign in to use the AI study assistant</p>
                <button class="btn btn-primary" onclick="showPage('auth')">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </div>
        `;
        return;
    }
    container.innerHTML = `
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-container">
            <input type="text" id="chat-input" class="chat-input" placeholder="Ask me anything about ${window.currentCourse.title}..." onkeypress="handleChatKeyPress(event)">
            <button class="btn btn-primary" onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </div>
    `;
    addChatMessage('bot', `Hello! I'm your AI study assistant for ${window.currentCourse.title}. How can I help you today?`);
}
function handleChatKeyPress(e) {
    if (e.key === 'Enter') sendChatMessage();
}
function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;
    addChatMessage('user', msg);
    input.value = '';
    setTimeout(() => {
        const replies = [
            "Great question! Here's a helpful explanation:",
            "This is a key concept for your exam. Let me break it down:",
            "I understand this can be tricky. Here's what you need to know:"
        ];
        addChatMessage('bot', replies[Math.floor(Math.random() * replies.length)]);
    }, 1000);
}
function addChatMessage(sender, text) {
    const box = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = `message ${sender}`;
    div.innerHTML = `<i class="fas fa-${sender === 'user' ? 'user' : 'robot'}"></i> ${text}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

// ===== COMMUNITY =====
function renderCommunityPage() {
    const uploadSelect = document.getElementById('upload-course-select');
    const filterSelect = document.getElementById('filter-course');
    uploadSelect.innerHTML = '<option value="">Select a course</option>';
    filterSelect.innerHTML = '<option value="">All Courses</option>';
    window.appData.courses.forEach(c => {
        uploadSelect.innerHTML += `<option value="${c.id}">${c.title}</option>`;
        filterSelect.innerHTML += `<option value="${c.id}">${c.title}</option>`;
    });
    document.getElementById('upload-guest-message').classList.toggle('hidden', !!window.currentUser);
    applyFilters();
}
function uploadNote() {
    if (!window.currentUser) return showNotification('Sign in to share notes', 'error');
    const courseId = parseInt(document.getElementById('upload-course-select').value);
    const title = document.getElementById('upload-note-title').value.trim();
    const content = document.getElementById('upload-note-content').value.trim();
    if (!courseId || !title || !content) return showNotification('Fill all fields', 'error');
    const note = {
        id: Date.now(), courseId, title, content,
        author: window.currentUser.name, authorId: window.currentUser.id,
        createdAt: new Date().toISOString(), downloads: 0, ratings: [], averageRating: 0
    };
    window.appData.communityNotes.push(note);
    saveData();
    renderCommunityPage();
    document.getElementById('upload-note-title').value = '';
    document.getElementById('upload-note-content').value = '';
    document.getElementById('upload-course-select').value = '';
    showNotification('Note shared', 'success');
}
function applyFilters() {
    const courseId = document.getElementById('filter-course').value;
    const minRating = document.getElementById('filter-rating').value;
    const sort = document.getElementById('filter-sort').value;
    let notes = [...window.appData.communityNotes];
    if (courseId) notes = notes.filter(n => n.courseId == courseId);
    if (minRating) notes = notes.filter(n => n.averageRating >= parseInt(minRating));
    notes.sort((a, b) => {
        if (sort === 'rating') return b.averageRating - a.averageRating;
        if (sort === 'newest') return new Date(b.createdAt) - new Date(a.createdAt);
        if (sort === 'oldest') return new Date(a.createdAt) - new Date(b.createdAt);
    });
    renderCommunityNotes(notes);
}
function renderCommunityNotes(notes) {
    const list = document.getElementById('community-notes-list');
    list.innerHTML = '';
    notes.forEach(note => {
        const course = window.appData.courses.find(c => c.id === note.courseId);
        const card = document.createElement('div');
        card.className = 'note-card';
        card.innerHTML = `
            <div class="note-meta">${course ? course.title : 'Unknown Course'} â€¢ by ${note.author} â€¢ ${new Date(note.createdAt).toLocaleDateString()}</div>
            <h3 class="mb-2">${note.title}</h3>
            <div class="rating-display mb-2">${generateStars(note.averageRating)} <span>(${note.ratings.length} ratings)</span></div>
            <button class="btn btn-outline" onclick="viewNote(${note.id})">
                <i class="fas fa-eye"></i> View Notes
            </button>
        `;
        list.appendChild(card);
    });
}
function generateStars(rating) {
    let html = '';
    for (let i = 1; i <= 5; i++) {
        html += `<i class="fas fa-star" style="color:${i <= rating ? '#fbbf24' : '#d1d5db'}"></i>`;
    }
    return html;
}
function viewNote(id) {
    const note = window.appData.communityNotes.find(n => n.id === id);
    if (!note) return;
    window.currentNote = note;
    document.getElementById('view-note-title').textContent = note.title;
    document.getElementById('view-note-meta').textContent = `by ${note.author} â€¢ ${new Date(note.createdAt).toLocaleDateString()}`;
    document.getElementById('view-rating-stars').innerHTML = generateStars(note.averageRating);
    document.getElementById('view-rating-text').textContent = `${note.averageRating.toFixed(1)} (${note.ratings.length} ratings)`;
    const userSection = document.getElementById('user-rating-section');
    userSection.classList.toggle('hidden', !window.currentUser || window.currentUser.id === note.authorId);
    resetUserRating();
    document.getElementById('view-note-content').innerHTML = parseMarkdown(note.content);
    showPage('note-view');
}
function resetUserRating() {
    window.userRating = 0;
    document.querySelectorAll('#user-rating-stars .rating-star').forEach(s => s.classList.remove('active'));
}
function setUserRating(rating) {
    window.userRating = rating;
    document.querySelectorAll('#user-rating-stars .rating-star').forEach((s, i) => {
        s.classList.toggle('active', i < rating);
    });
}
function submitRating() {
    if (!window.currentUser || !window.currentNote || window.userRating === 0) return showNotification('Select a rating', 'error');
    const note = window.currentNote;
    const userId = window.currentUser.id;
    if (!note.ratings) note.ratings = [];
    const existing = note.ratings.find(r => r.userId === userId);
    if (existing) existing.rating = window.userRating;
    else note.ratings.push({ userId, rating: window.userRating });
    note.averageRating = note.ratings.reduce((a, b) => a + b.rating, 0) / note.ratings.length;
    const index = window.appData.communityNotes.findIndex(n => n.id === note.id);
    if (index !== -1) window.appData.communityNotes[index] = note;
    saveData();
    viewNote(note.id);
    showNotification('Rating submitted', 'success');
}

// ===== DEV DASHBOARD =====
function renderDevDashboard() {
    if (!window.developerModeEnabled) {
        document.getElementById('dev-password-section').classList.remove('hidden');
        document.getElementById('dev-content').classList.add('hidden');
        return;
    }
    document.getElementById('dev-password-section').classList.add('hidden');
    document.getElementById('dev-content').classList.remove('hidden');
    document.getElementById('total-users').textContent = window.appData.analytics.totalUsers;
    document.getElementById('guest-users').textContent = window.appData.analytics.guestUsers;
    document.getElementById('total-notes').textContent = window.appData.communityNotes.length;
    document.getElementById('avg-session').textContent = calculateAvgSessionTime();
    const usersBody = document.getElementById('users-table-body');
    usersBody.innerHTML = '';
    window.appData.users.forEach(u => {
        usersBody.innerHTML += `
            <tr class="table-row">
                <td>${u.name}</td>
                <td>${u.email}</td>
                <td>${new Date(u.createdAt).toLocaleDateString()}</td>
            </tr>
        `;
    });
    const activityBody = document.getElementById('activity-table-body');
    activityBody.innerHTML = '';
    window.appData.analytics.sessions.slice(-10).reverse().forEach(s => {
        activityBody.innerHTML += `
            <tr class="table-row">
                <td>${s.ev}</td>
                <td>${s.userId || 'Guest'}</td>
                <td>${new Date(s.timestamp).toLocaleString()}</td>
            </tr>
        `;
    });
}
function enableDeveloperMode() {
    const password = document.getElementById('dev-password').value;
    if (password === '6767') {
        window.developerModeEnabled = true;
        updateDeveloperMode();
        renderDevDashboard();
        showNotification('Developer mode enabled', 'success');
    } else {
        showNotification('Incorrect password', 'error');
    }
}
function calculateAvgSessionTime() {
    return Math.floor(Math.random() * 30) + 'm';
}

// ===== AUTH =====
function updateAuthUI() {
    const btn = document.getElementById('auth-button');
    if (window.currentUser) {
        btn.innerHTML = `<i class="fas fa-sign-out-alt"></i> ${window.currentUser.name}`;
        btn.onclick = () => signOut();
    } else {
        btn.innerHTML = `<i class="fas fa-sign-in-alt"></i> Sign In`;
        btn.onclick = () => showPage('auth');
    }
}
function toggleAuthMode() {
    window.isSignUpMode = !window.isSignUpMode;
    const title = document.getElementById('auth-title');
    const submit = document.getElementById('auth-submit-text');
    const toggle = document.getElementById('auth-toggle-text');
    const nameField = document.getElementById('name-field');
    if (window.isSignUpMode) {
        title.textContent = 'Sign Up';
        submit.textContent = 'Sign Up';
        toggle.textContent = 'Already have an account? Sign In';
        nameField.classList.remove('hidden');
    } else {
        title.textContent = 'Sign In';
        submit.textContent = 'Sign In';
        toggle.textContent = "Don't have an account? Sign Up";
        nameField.classList.add('hidden');
    }
}
function handleAuth(e) {
    e.preventDefault();
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    const name = document.getElementById('auth-name').value.trim();
    if (window.isSignUpMode) {
        if (!name) return showNotification('Enter your name', 'error');
        if (window.appData.users.find(u => u.email === email)) return showNotification('User exists', 'error');
        const user = { id: Date.now(), email, password, name, createdAt: new Date().toISOString() };
        window.appData.users.push(user);
        window.currentUser = user;
        window.appData.analytics.totalUsers++;
        window.appData.analytics.registeredUsers++;
        saveData();
        updateUI();
        showPage('home');
        showNotification('Account created', 'success');
        trackEvent('user_signup', { userId: user.id });
    } else {
        const user = window.appData.users.find(u => u.email === email && u.password === password);
        if (!user) return showNotification('Invalid credentials', 'error');
        window.currentUser = user;
        saveData();
        updateUI();
        showPage('home');
        showNotification(`Welcome back, ${user.name}`, 'success');
        trackEvent('user_signin', { userId: user.id });
    }
}
function signOut() {
    window.currentUser = null;
    saveData();
    updateUI();
    showNotification('Goodbye', 'info');
    trackEvent('user_signout');
}
function updateUI() {
    updateAuthUI();
    if (window.currentCourse) initializeChat();
}

// ===== UTILS =====
function showNotification(msg, type = 'info') {
    const bar = document.getElementById('notification-bar');
    const content = document.getElementById('notification-content');
    const text = document.getElementById('notification-text');
    const icon = document.getElementById('notification-icon');
    text.textContent = msg;
    content.className = 'notification-content';
    switch (type) {
        case 'success': content.classList.add('notification-success'); icon.className = 'fas fa-check-circle'; break;
        case 'error': content.classList.add('notification-error'); icon.className = 'fas fa-exclamation-circle'; break;
        default: content.classList.add('notification-info'); icon.className = 'fas fa-info-circle'; break;
    }
    bar.classList.add('show');
    setTimeout(() => bar.classList.remove('show'), 3000);
}
function parseMarkdown(text) {
    return text
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^- (.*$)/gm, '<li>$1</li>')
        .replace(/\n/g, '<br>')
        .replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
}
function isValidUrl(string) {
    try { new URL(string); return true; } catch { return false; }
}
function trackEvent(ev, data = {}) {
    window.appData.analytics.sessions.push({ ev, timestamp: new Date().toISOString(), userType: window.currentUser ? 'registered' : 'guest', userId: window.currentUser?.id, ...data });
    if (window.appData.analytics.sessions.length > 1000) window.appData.analytics.sessions = window.appData.analytics.sessions.slice(-1000);
    if (ev === 'user_signup') {
        window.appData.analytics.totalUsers++;
        window.appData.analytics.registeredUsers++;
    }
    saveData();
}
window.addEventListener('beforeunload', () => trackEvent('session_end'));
</script>
</body>
</html>