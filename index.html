<script>
/* ========  STATE  ======== */
let appData = {
  courses: [ {id:1, title:"AP Calculus AB", icon:"ðŸ“Š", description:"Master limits, derivatives, and integrals",
              notes:"# AP Calculus AB\n\n<details><summary>Unit 1 â€¦</summary>â€¦</details>",
              links:[{title:"College Board",url:"https://apstudents.collegeboard.org/courses/ap-calculus-ab"}]}, 
            {id:2, title:"AP Biology",      icon:"ðŸ§¬", description:"Explore the science of life",
              notes:"# AP Biology\n\n<details><summary>Unit 1 â€¦</summary>â€¦</details>",
              links:[{title:"College Board",url:"https://apstudents.collegeboard.org/courses/ap-biology"}]} ],
  users:[], communityNotes:[],  analytics:{totalUsers:0,guestUsers:0,registeredUsers:0,sessions:[],pageViews:{}}
};
let currentUser = null, isDeveloperMode = false, currentCourseId = null, isSignUp = false;

/* ========  LIFE-CYCLE  ======== */
document.addEventListener('DOMContentLoaded', ()=>{
  loadData();
  renderCourses();
  updateAuthButton();
  initAnalytics();
  populateCourseSelect();
  renderCommunityNotes();
});

/* ========  DATA  ======== */
function loadData(){
  const d=localStorage.getItem('apExamAppData'), u=localStorage.getItem('currentUser');
  if(d){appData=JSON.parse(d);}
  if(u){currentUser=JSON.parse(u);}
}
function saveData(){localStorage.setItem('apExamAppData',JSON.stringify(appData));}
function saveCurrentUser(){localStorage.setItem('currentUser',JSON.stringify(currentUser));}

/* ========  UI HELPERS  ======== */
function showNotification(msg,type='info'){
  const box=document.getElementById('notification'), txt=document.getElementById('notification-text');
  txt.textContent=msg; box.className=`notification ${type} show`;
  setTimeout(()=>box.classList.remove('show'),3000);
}
function showPage(name){
  document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active'));
  document.getElementById(name+'-page').classList.add('active');
  trackEvent('page_view',{page:name});
}

/* ========  COURSES  ======== */
function renderCourses(){
  const grid=document.getElementById('course-grid');
  grid.innerHTML='';
  appData.courses.forEach(c=>{
    const card=document.createElement('div');
    card.className='course-card fade-in';
    card.innerHTML=`
      <button class="delete-btn" onclick="deleteCourse(event,${c.id})"><i class="fas fa-times"></i></button>
      <span class="course-icon">${c.icon}</span>
      <h3 class="course-title">${c.title}</h3>
      <p class="course-description">${c.description}</p>`;
    card.addEventListener('click',e=>{
      if(!e.target.closest('.delete-btn')){showCourseDetail(c.id);}
    });
    grid.appendChild(card);
  });
}
function showCourseDetail(id){
  currentCourseId=id;
  const c=appData.courses.find(x=>x.id===id);
  document.getElementById('course-detail-title').innerHTML=`${c.icon} ${c.title}`;
  document.getElementById('course-notes').innerHTML=renderMarkdown(c.notes);
  document.getElementById('notes-editor').value=c.notes;
  document.getElementById('course-links').innerHTML=c.links.map(l=>`
    <div class="link-card">
      <a href="${l.url}" target="_blank">${l.title}</a>
      <button class="btn btn-outline" onclick="deleteLink(${id},'${l.url}')" style="padding:.25rem .5rem"><i class="fas fa-trash"></i></button>
    </div>`).join('');
  renderAIChat(id);
  showPage('course-detail');
}
function renderMarkdown(t){
  return t.replace(/^### (.*)/gm,'<h3>$1</h3>')
          .replace(/^## (.*)/gm,'<h2>$1</h2>')
          .replace(/^# (.*)/gm,'<h1>$1</h1>')
          .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
          .replace(/\n/g,'<br>');
}

/* ========  AUTH  ======== */
function toggleAuth(){
  if(currentUser){ trackEvent('user_signout',{userId:currentUser.id}); currentUser=null; saveCurrentUser(); updateAuthButton(); showNotification('Signed out','success');}
  else{showPage('auth');}
}
function toggleAuthMode(){
  isSignUp=!isSignUp;
  document.getElementById('auth-title').textContent=isSignUp?'Sign Up':'Sign In';
  document.getElementById('auth-submit').textContent=isSignUp?'Sign Up':'Sign In';
  document.getElementById('name-group').style.display=isSignUp?'block':'none';
  document.getElementById('auth-toggle').textContent=isSignUp?'Already have an account? Sign in':'Don\'t have an account? Sign up';
}
function handleAuth(e){
  e.preventDefault();
  const email=document.getElementById('auth-email').value.trim(),
        pwd=document.getElementById('auth-password').value.trim(),
        name=document.getElementById('auth-name').value.trim();

  if(!email||!pwd){showNotification('Fill required fields','error'); return;}
  if(isSignUp&&!name){showNotification('Enter name','error'); return;}

  if(isSignUp){
    if(appData.users.find(u=>u.email===email)){showNotification('User exists','error'); return;}
    const nu={id:Date.now(), email, password:pwd, name, createdAt:new Date().toISOString()};
    appData.users.push(nu); currentUser=nu; appData.analytics.registeredUsers++;
    trackEvent('user_signup',{userId:nu.id});
    showNotification('Account created','success');
  }else{
    const u=appData.users.find(x=>x.email===email&&x.password===pwd);
    if(!u){showNotification('Invalid credentials','error'); return;}
    currentUser=u; trackEvent('user_signin',{userId:u.id});
    showNotification('Welcome back','success');
  }
  saveData(); saveCurrentUser(); updateAuthButton(); showPage('home');
}
function updateAuthButton(){
  const btn=document.getElementById('auth-text'), info=document.getElementById('user-info'), name=document.getElementById('user-name');
  if(currentUser){btn.textContent='Sign Out'; info.classList.remove('hidden'); name.textContent=currentUser.name;}
  else{btn.textContent='Sign In'; info.classList.add('hidden');}
}

/* ========  COMMUNITY  ======== */
function populateCourseSelect(){
  const s=document.getElementById('upload-course');
  if(!s||!appData.courses.length){s.innerHTML='<option value="">No courses</option>'; return;}
  s.innerHTML=appData.courses.map(c=>`<option value="${c.id}">${c.title}</option>`).join('');
}
function uploadNote(){
  if(!currentUser){showNotification('Please sign in','error'); showPage('auth'); return;}
  const cid=parseInt(document.getElementById('upload-course').value),
        ttl=document.getElementById('upload-title').value.trim(),
        cnt=document.getElementById('upload-content').value.trim();
  if(!ttl||!cnt){showNotification('Fill all fields','error'); return;}
  const note={id:Date.now(), courseId:cid, title:ttl, content:cnt,
              author:currentUser.name, authorId:currentUser.id,
              createdAt:new Date().toISOString(), downloads:0};
  appData.communityNotes.push(note); saveData(); renderCommunityNotes();
  document.getElementById('upload-title').value='';
  document.getElementById('upload-content').value='';
  trackEvent('note_uploaded',{noteId:note.id, userId:currentUser.id});
  showNotification('Notes shared','success');
}
function renderCommunityNotes(){
  const box=document.getElementById('community-notes'),
        notes=appData.communityNotes.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  if(!box)return;
  if(!notes.length){box.innerHTML='<p>No community notes yet. Be the first!</p>'; return;}
  box.innerHTML=notes.map(n=>{
    const c=appData.courses.find(x=>x.id===n.courseId);
    return `<div class="note-item">
      <div class="note-meta">
        <span><strong>${n.title}</strong> â€“ ${c?c.title:'Unknown'}</span>
        <span>by ${n.author} â€¢ ${new Date(n.createdAt).toLocaleDateString()}</span>
      </div>
      <button class="btn btn-primary" onclick="viewNote(${n.id})"><i class="fas fa-eye"></i> View</button>
    </div>`;
  }).join('');
}
function viewNote(id){
  const n=appData.communityNotes.find(x=>x.id===id);
  if(n){const c=appData.courses.find(x=>x.id===n.courseId); alert(`${n.title}\nCourse: ${c?c.title:'Unknown'}\nAuthor: ${n.author}\n\n${n.content}`);}
}

/* ========  DEV-MODE GATE  ======== */
function toggleDevMode(){
  if(document.getElementById('dev-password').value!=='6767'){showNotification('Wrong password','error'); return;}
  isDeveloperMode=!isDeveloperMode;
  document.body.classList.toggle('developer-mode');
  document.getElementById('dev-controls').classList.toggle('hidden');
  document.getElementById('dev-stats').classList.toggle('hidden');
  if(isDeveloperMode) updateDevDashboard();
  showNotification(isDeveloperMode?'Dev on':'Dev off','success');
  trackEvent('dev_mode_toggle',{enabled:isDeveloperMode});
}
function updateDevDashboard(){
  document.getElementById('total-users').textContent=appData.users.length;
  document.getElementById('guest-users').textContent=appData.analytics.guestUsers;
  document.getElementById('total-notes').textContent=appData.communityNotes.length;
  const sessions=appData.analytics.sessions;
  if(sessions.length){
    const avg=sessions.reduce((a,s)=>a+(s.duration||0),0)/sessions.length;
    document.getElementById('avg-session').textContent=Math.round(avg)+'m';
  }
  const box=document.getElementById('users-container');
  box.innerHTML=appData.users.length
    ? appData.users.map(u=>`<div class="user-item"><div><div class="user-name">${u.name}</div><div class="user-email">${u.email}</div></div><div class="user-time">${new Date(u.createdAt).toLocaleDateString()}</div></div>`).join('')
    :'<p>No registered users</p>';
}

/* ========  ANALYTICS  ======== */
function initAnalytics(){
  trackEvent('page_view',{page:'home'});
  let start=Date.now();
  window.addEventListener('beforeunload',()=>trackEvent('session_end',{duration:Math.round((Date.now()-start)/60000)}));
}
function trackEvent(ev,p={}){
  appData.analytics.sessions.push({ev, timestamp:new Date().toISOString(), userType:currentUser?'registered':'guest', userId:currentUser?currentUser.id:null, ...p});
  if(!currentUser&&ev!=='page_view') appData.analytics.guestUsers++;
  if(appData.analytics.sessions.length>1000) appData.analytics.sessions=appData.analytics.sessions.slice(-1000);
  saveData();
}

/* ========  MISC UTILS  ======== */
function deleteCourse(e,id){e.stopPropagation(); if(confirm('Delete course?')){appData.courses=appData.courses.filter(c=>c.id!==id); saveData(); renderCourses(); populateCourseSelect(); showNotification('Deleted','success');}}
function deleteLink(cid,url){const c=appData.courses.find(x=>x.id===cid); if(c){c.links=c.links.filter(l=>l.url!==url); saveData(); showCourseDetail(cid);}}
function addLink(){const t=prompt('Title'),u=prompt('URL'); if(t&&u){const c=appData.courses.find(x=>x.id===currentCourseId); if(c){c.links.push({title:t,url:u}); saveData(); showCourseDetail(currentCourseId);}}}
function showAddCourseForm(){const t=prompt('Course title'); if(t){const i=prompt('Icon (emoji)')||'ðŸ“š',d=prompt('Description')||''; appData.courses.push({id:Date.now(),title:t,icon:i,description:d,notes:`# ${t}\nAdd notesâ€¦`,links:[]}); saveData(); renderCourses(); populateCourseSelect(); showNotification('Added','success');}}
</script>
